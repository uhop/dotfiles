#!/usr/bin/env bash

set -euCo pipefail
shopt -s expand_aliases

. ~/.local/libs/main.sh

script_dir="$(dirname "$(readlink -f "$0")")"
script_name=$(basename "$0")

args::program "$script_name" "1.0" "Update software with available package managers"
args_program_usage="${args_help_program}${args_program_name}${args_help_reset} ${args_help_option}[options]${args_help_reset}"

args::option "-c, --clean" "Run the cleanup script ${BOLD}cln${RESET_ALL} after updating"
args::option "-y, --yes" "Assume \"yes\" to all prompts"
args::option "-v, --version" "Show version"
args::option "-h, --help" "Show help"

args::parse "$@"
eval set -- "${args_cleaned}"

groups "$(id -un)" | grep -qE '\b(sudo|admin|wheel)\b'
hasSudo=$?

WARN="${BOLD}${BRIGHT_WHITE}${BG_BLUE}"
PROMPT="${BOLD}${FG_CYAN}"

ASSUME_YES=''
if [[ -v args_options["-y"] ]]; then ASSUME_YES='-y'; fi

{{ if eq .osIdLike "linux-debian" -}}
if [ "$hasSudo" -eq 0 ]; then
  ansi::out "${WARN}apt may require sudo: expect asking for the sudo password.${RESET_ALL}"
  echoRunBold sudo apt update
  echoRunBold sudo apt upgrade $ASSUME_YES

  ansi::out "${WARN}snap may require sudo: expect asking for the sudo password.${RESET_ALL}"
  echoRunBold sudo snap refresh

  if command -v flatpak &> /dev/null; then
    echoRunBold flatpak update $ASSUME_YES
  fi
fi
{{- else if eq .osIdLike "darwin" -}}
if [ "$hasSudo" -eq 0 ]; then
  ansi::out "${WARN}softwareupdate may require sudo: expect asking for the sudo password.${RESET_ALL}"
  echoRunBold sudo softwareupdate -i -a

  ansi::out "${WARN}mas may require sudo: expect asking for the sudo password.${RESET_ALL}"
  echoRunBold sudo mas upgrade
fi
{{- end }}

echoRunBold brew update
echoRunBold brew upgrade

if command -v tmux &> /dev/null; then
  if [ -f "$HOME/.config/tmux/plugins/tpm/bin/update_plugins" ]; then
    ansi::out "${PROMPT}Update tmux plugins...${RESET_ALL}"
    "$HOME/.config/tmux/plugins/tpm/bin/update_plugins" all
  fi
fi

if command -v bun &> /dev/null; then
  echoRunBold bun upgrade --stable
fi

{{ if eq .osIdLike "linux-debian" -}}
if compgen -G "/run/reb*" > /dev/null; then
	ansi::out "${WARN}WARNING: reboot is ${BLINK}${REVERSE}required${RESET_ALL}${WARN}. To reboot run: ${ITALIC}reboot${RESET_ALL}${WARN} or ${ITALIC}sudo shutdown -r now${RESET_ALL}"
fi
{{- end }}

if [[ -v args_options["-c"] ]]; then
  ansi::out "\n${PROMPT}Clean up...${RESET_ALL}\n"
  cln $ASSUME_YES
fi

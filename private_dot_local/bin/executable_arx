#!/usr/bin/env bash

set -euCo pipefail
shopt -s expand_aliases

. ~/.local/libs/main.sh

script_dir="$(dirname "$(readlink -f "$0")")"
script_name=$(basename "$0")

args::program "$script_name" "1.0" "View/extract archives"
# args_program_usage="${args_help_program}${args_program_name}${args_help_reset} ${args_help_option}[options]${args_help_reset} ${args_help_command_arg}<archive>${args_help_reset}"
args_program_required_command="no"

args::option "list, l" "List available files (default)" "file-name"
args::option "extract, x" "Extract all files" "file-name [path-to]"

args::option "-v, --version" "Show version"
args::option "-h, --help" "Show help"

args::parse "$@"
eval set -- "${args_cleaned}"

ERROR="$BOLD$BRIGHT_WHITE$BG_RED"

if [ -z "${1:-}" ]; then
  args::option::help
fi

if [ -z "${args_command:-}" ]; then
  args_command="list"
  file_name="${1:-}"
else
  file_name="${2:-}"
fi

if [ -z "${file_name:-}" ]; then
  ansi::err "${ERROR}No file name is specified.${RESET_ALL}"
  exit 1
fi

if [[ "$args_command" == "extract" ]]; then
  path_to="${3:-}"
fi

requiresDir () { # usage: requiresDir <file>
  case "$1" in
    *.tar.br)    echo yes ;;
    *.tar.bz2)   echo yes ;;
    *.tar.gz)    echo yes ;;
    *.bz2)       echo no  ;;
    *.rar)       echo yes ;;
    *.gz)        echo no  ;;
    *.tar)       echo yes ;;
    *.tbz2)      echo yes ;;
    *.tgz)       echo yes ;;
    *.zip)       echo yes ;;
    *.Z)         echo no  ;;
    *.7z)        echo yes ;;
    *.deb)       echo yes ;;
    *.tar.xz)    echo yes ;;
    *.tar.zst)   echo yes ;;
    *)           echo     ;;
  esac
}

extract () { # usage: extract <file> <to>
  if [ ! -f "$1" ]; then
    ansi::err "${ERROR}'$1' is not a valid file${RESET_ALL}"
    exit 1
  fi
  if [ -n "$2" ]; then
    reqDir="$(requiresDir "$1")"
    if [[ "$reqDir" == "yes" ]]; then
      if [ ! -d "$2" ]; then
        echoRun mkdir -p "$2"
      fi
    elif [[ "$reqDir" == "no" ]]; then
      dir="$(dirname "$2")"
      if [ ! -d "$dir" ]; then
        echoRun mkdir -p "$dir"
      fi
    fi
  fi
  file_name="$(printf '%q' "$1")"
  path_to="$(printf '%q' "$2")"
  case "${file_name}" in
    *.tar.br)    echoRun tar xvf "${file_name}" -I brotli ${path_to:+-C "$path_to"} ;;
    *.tar.bz2)   echoRun tar xjvf "${file_name}" ${path_to:+-C "$path_to"}          ;;
    *.tar.gz)    echoRun tar xzvf "${file_name}" ${path_to:+-C "$path_to"}          ;;
    *.bz2)       echoRun bunzip2 "${file_name}" ${path_to:+-c > "$path_to"}         ;;
    *.rar)       echoRun unrar x "${file_name}" "$path_to"                    ;;
    *.gz)        echoRun gunzip "${file_name}" ${path_to:+-c > "$path_to"}          ;;
    *.tar)       echoRun tar xvf "${file_name}" ${path_to:+-C "$path_to"}           ;;
    *.tbz2)      echoRun tar xjvf "${file_name}" ${path_to:+-C "$path_to"}          ;;
    *.tgz)       echoRun tar xzvf "${file_name}" ${path_to:+-C "$path_to"}          ;;
    *.zip)       echoRun unzip "${file_name}" ${path_to:+-d "$path_to"}             ;;
    *.Z)         echoRun uncompress "${file_name}" ${path_to:+-c > "$path_to"}        ;;
    *.7z)        echoRun 7z x "${file_name}" ${path_to:+-o"$path_to"}           ;;
    *.deb)       echoRun ar x "${file_name}" ${path_to:+--output="$path_to"}        ;;
    *.tar.xz)    echoRun tar xJvf "${file_name}" ${path_to:+-C "$path_to"}          ;;
    *.tar.zst)   echoRun tar --zstd -xvf "${file_name}" ${path_to:+-C "$path_to"}   ;;
    *)           ansi::err "${ERROR}'$1' cannot be extracted${RESET_ALL}"; exit 1 ;;
  esac
}

list () { # usage: list <file>
  if [ ! -f "$1" ]; then
    ansi::err "${ERROR}'$1' is not a valid file${RESET_ALL}"
    exit 1
  fi
  file_name="$(printf '%q' "$1")"
  case "${file_name}" in
    *.tar.br)    echoRun tar tvf "${file_name}" -I brotli ;;
    *.tar.bz2)   echoRun tar tjvf "${file_name}"          ;;
    *.tar.gz)    echoRun tar tzvf "${file_name}"          ;;
    *.bz2)       echoRun bunzip2 -l "${file_name}"        ;;
    *.rar)       echoRun unrar l "${file_name}"           ;;
    *.gz)        echoRun gunzip -l "${file_name}"         ;;
    *.tar)       echoRun tar tvf "${file_name}"           ;;
    *.tbz2)      echoRun tar tjvf "${file_name}"          ;;
    *.tgz)       echoRun tar tzvf "${file_name}"          ;;
    *.zip)       echoRun unzip -l "${file_name}"          ;;
    *.Z)         echoRun uncompress -l "${file_name}"     ;;
    *.7z)        echoRun 7z l "${file_name}"              ;;
    *.deb)       echoRun ar t "${file_name}"              ;;
    *.tar.xz)    echoRun tar tJvf "${file_name}"          ;;
    *.tar.zst)   echoRun tar --zstd -tvf "${file_name}"   ;;
    *)           ansi::err "${ERROR}'$1' cannot be listed${RESET_ALL}"; exit 1 ;;
  esac
}

case "$args_command" in
  "list")
    list "$file_name"
    ;;
  "extract")
    extract "$file_name" "$path_to"
    ;;
  *)
    ansi::err "${ERROR}Unknown command: $args_command${RESET_ALL}"
    exit 1
    ;;
esac
